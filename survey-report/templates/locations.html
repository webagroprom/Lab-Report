<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–æ–∫–∞—Ü–∏–∏ - –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç –ø–æ –æ–ø—Ä–æ—Å—É</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #17a2b8;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .nav-link {
            color: var(--primary) !important;
            font-weight: 600;
            padding: 12px 20px !important;
            border-radius: 8px;
            margin: 0 5px;
            transition: all 0.3s;
        }
        
        .nav-link.active {
            background: var(--secondary);
            color: white !important;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .header-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .metric-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 15px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border-left: 4px solid var(--success);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }
        
        .location-card {
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 5px solid;
            background: white;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }
        
        .location-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.15);
        }
        
        .location-office { border-color: var(--secondary); }
        .location-factory { border-color: var(--success); }
        .location-home { border-color: var(--danger); }
        .location-warehouse { border-color: var(--warning); }
        .location-default { border-color: var(--info); }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .chart-img {
            width: 100%;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        
        .progress-custom {
            height: 25px;
            border-radius: 12px;
            background: rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .progress-custom .progress-bar {
            border-radius: 12px;
            background: linear-gradient(90deg, var(--success), var(--info));
        }
        
        .badge-category {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .table-custom {
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            background: white;
        }
        
        .table-custom thead th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            font-weight: 600;
            padding: 20px;
        }
        
        .table-custom tbody tr:hover {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/" style="font-weight: 800; font-size: 1.5rem;">
                <i class="fas fa-chart-network text-primary"></i> 
                <span style="background: linear-gradient(135deg, var(--primary), var(--secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                    IT –û—Ç—á–µ—Ç –ø–æ –æ–ø—Ä–æ—Å—É
                </span>
            </a>
            <div class="navbar-nav">
                <a class="nav-link active" href="/locations">
                    <i class="fas fa-map-marked-alt"></i> –õ–æ–∫–∞—Ü–∏–∏
                </a>
                <a class="nav-link" href="/questions">
                    <i class="fas fa-poll-h"></i> –í–æ–ø—Ä–æ—Å—ã
                </a>
                <a class="nav-link" href="/tasks">
                    <i class="fas fa-tasks"></i> –ó–∞–¥–∞—á–∏
                </a>
                <a class="nav-link" href="/import">
                    <i class="fas fa-file-import"></i> –ò–º–ø–æ—Ä—Ç
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="main-container">
            <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
            <div class="header-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="display-4 mb-3">
                            <i class="fas fa-map-marked-alt"></i> üìç –í—Å–µ –ª–æ–∫–∞—Ü–∏–∏
                        </h1>
                        <p class="lead mb-0">–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –ª–æ–∫–∞—Ü–∏—è–º, —É—á–∞—Å—Ç–≤–æ–≤–∞–≤—à–∏–º –≤ –æ–ø—Ä–æ—Å–µ IT —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="bg-white text-dark rounded-pill px-4 py-3 d-inline-block shadow">
                            <small class="text-muted d-block">–û–±–Ω–æ–≤–ª–µ–Ω–æ</small>
                            <strong class="fs-5">{{ now_time }}</strong>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card text-center">
                        <div class="stat-number">{{ locations|length }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –ª–æ–∫–∞—Ü–∏–π</div>
                        <div class="mt-3">
                            {% set office_count = locations|selectattr('category', 'equalto', 'office')|list|length %}
                            {% set factory_count = locations|selectattr('category', 'equalto', 'factory')|list|length %}
                            <span class="badge bg-primary badge-category">ÔøΩÔøΩ –û—Ñ–∏—Å—ã: {{ office_count }}</span>
                            <span class="badge bg-success badge-category mt-2 d-block">üè≠ –ó–∞–≤–æ–¥—ã: {{ factory_count }}</span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card text-center">
                        <div class="stat-number">{{ total_responses }}</div>
                        <div class="stat-label">–í—Å–µ–≥–æ –æ—Ç–≤–µ—Ç–æ–≤</div>
                        <div class="mt-3">
                            {% set avg_responses = (total_responses/locations|length)|round(1) if locations|length > 0 else 0 %}
                            <span class="badge bg-info badge-category">
                                üìä –°—Ä–µ–¥–Ω–µ–µ: {{ avg_responses }}
                            </span>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card text-center">
                        <div class="stat-number">{{ avg_satisfaction }}/10</div>
                        <div class="stat-label">–°—Ä–µ–¥–Ω—è—è —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</div>
                        <div class="mt-3">
                            {% if avg_satisfaction >= 8 %}
                            <span class="badge bg-success badge-category">üéâ –û—Ç–ª–∏—á–Ω–æ</span>
                            {% elif avg_satisfaction >= 6 %}
                            <span class="badge bg-warning badge-category">üëç –•–æ—Ä–æ—à–æ</span>
                            {% elif avg_satisfaction >= 4 %}
                            <span class="badge bg-secondary badge-category">üòê –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–∏—Ç–µ–ª—å–Ω–æ</span>
                            {% else %}
                            <span class="badge bg-danger badge-category">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏–π</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card text-center">
                        <div class="stat-number">{{ (avg_satisfaction * 10)|round(1) }}%</div>
                        <div class="stat-label">–û–±—â–∏–π –∏–Ω–¥–µ–∫—Å NPS</div>
                        <div class="mt-3">
                            {% set nps = avg_satisfaction * 10 %}
                            <div class="progress progress-custom">
                                <div class="progress-bar" style="width: {{ nps }}%"></div>
                            </div>
                            <small class="text-muted">{{ nps|round(1) }}% —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ -->
            {% if chart %}
            <div class="chart-container">
                <h3 class="mb-4">
                    <i class="fas fa-chart-bar text-primary"></i> üìä –£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø–æ –≤—Å–µ–º –ª–æ–∫–∞—Ü–∏—è–º
                </h3>
                <img src="data:image/png;base64,{{ chart }}" alt="–ì—Ä–∞—Ñ–∏–∫ —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç–∏" class="chart-img">
                <div class="row mt-3 text-center">
                    <div class="col-md-3">
                        <div class="text-success">
                            <i class="fas fa-arrow-up"></i> –õ—É—á—à–∞—è: 
                            {% if locations %}
                                {% set best = locations|sort(attribute='satisfaction', reverse=true)|first %}
                                {{ best.name }} ({{ best.satisfaction }}/10)
                            {% else %}
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-warning">
                            <i class="fas fa-chart-line"></i> –°—Ä–µ–¥–Ω—è—è: {{ avg_satisfaction }}/10
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-danger">
                            <i class="fas fa-arrow-down"></i> –•—É–¥—à–∞—è: 
                            {% if locations %}
                                {% set worst = locations|sort(attribute='satisfaction')|first %}
                                {{ worst.name }} ({{ worst.satisfaction }}/10)
                            {% else %}
                                –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-info">
                            <i class="fas fa-bullseye"></i> –¶–µ–ª—å: 8.5/10
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ -->
            <div class="chart-container">
                <h3 class="mb-4">
                    <i class="fas fa-table text-success"></i> üìã –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –ª–æ–∫–∞—Ü–∏—è–º
                </h3>
                <div class="table-responsive">
                    <table class="table table-hover table-custom">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>–õ–æ–∫–∞—Ü–∏—è</th>
                                <th>–¢–∏–ø</th>
                                <th>–û—Ç–≤–µ—Ç—ã</th>
                                <th>–£–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–Ω–æ—Å—Ç—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                                <th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for location in locations %}
                            <tr>
                                <td class="fw-bold">{{ loop.index }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-3">
                                            {% if location.category == 'office' %}
                                            <i class="fas fa-building text-primary fa-lg"></i>
                                            {% elif location.category == 'factory' %}
                                            <i class="fas fa-industry text-success fa-lg"></i>
                                            {% elif location.category == 'home' %}
                                            <i class="fas fa-home text-danger fa-lg"></i>
                                            {% elif location.category == 'warehouse' %}
                                            <i class="fas fa-warehouse text-warning fa-lg"></i>
                                            {% else %}
                                            <i class="fas fa-map-marker text-info fa-lg"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong class="d-block">{{ location.name }}</strong>
                                            <small class="text-muted">ID: LOC{{ "%03d" % loop.index }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if location.category == 'office' %}
                                    <span class="badge bg-primary badge-category">
                                        <i class="fas fa-building"></i> –û—Ñ–∏—Å
                                    </span>
                                    {% elif location.category == 'factory' %}
                                    <span class="badge bg-success badge-category">
                                        <i class="fas fa-industry"></i> –ó–∞–≤–æ–¥
                                    </span>
                                    {% elif location.category == 'home' %}
                                    <span class="badge bg-danger badge-category">
                                        <i class="fas fa-home"></i> –î–æ–º. –æ—Ñ–∏—Å
                                    </span>
                                    {% elif location.category == 'warehouse' %}
                                    <span class="badge bg-warning badge-category">
                                        <i class="fas fa-warehouse"></i> –°–∫–ª–∞–¥
                                    </span>
                                    {% else %}
                                    <span class="badge bg-info badge-category">
                                        <i class="fas fa-map-marker"></i> –î—Ä—É–≥–æ–µ
                                    </span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="text-center">
                                        <div class="fs-5 fw-bold">{{ location.responses }}</div>
                                        <div class="progress progress-custom mt-2" style="height: 10px;">
                                            {% if total_responses > 0 %}
                                                {% set resp_perc = (location.responses / total_responses * 100)|round(1) %}
                                            {% else %}
                                                {% set resp_perc = 0 %}
                                            {% endif %}
                                            <div class="progress-bar bg-info" style="width: {{ resp_perc }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ resp_perc }}% –æ—Ç –æ–±—â–µ–≥–æ</small>
                                    </div>
                                </td>
                                <td>
                                    <div class="text-center">
                                        <div class="display-6 fw-bold" style="color: 
                                            {% if location.satisfaction >= 8 %}#27ae60
                                            {% elif location.satisfaction >= 6 %}#f39c12
                                            {% elif location.satisfaction >= 4 %}#95a5a6
                                            {% else %}#e74c3c{% endif %};">
                                            {{ location.satisfaction }}
                                        </div>
                                        <div class="progress progress-custom mt-2">
                                            <div class="progress-bar" style="width: {{ location.satisfaction * 10 }}%"></div>
                                        </div>
                                        <small class="text-muted">{{ location.satisfaction * 10 }}% –∏–∑ 100%</small>
                                    </div>
                                </td>
                                <td>
                                    {% if location.satisfaction >= 8 %}
                                    <span class="badge bg-success badge-category">
                                        <i class="fas fa-trophy"></i> –õ–∏–¥–µ—Ä
                                    </span>
                                    <div class="mt-2 text-success small">
                                        <i class="fas fa-check-circle"></i> –ü—Ä–µ–≤—ã—à–∞–µ—Ç —Ü–µ–ª—å
                                    </div>
                                    {% elif location.satisfaction >= 6 %}
                                    <span class="badge bg-warning badge-category">
                                        <i class="fas fa-chart-line"></i> –°—Ç–∞–±–∏–ª—å–Ω–æ
                                    </span>
                                    <div class="mt-2 text-warning small">
                                        <i class="fas fa-bullseye"></i> –ë–ª–∏–∑–∫–æ –∫ —Ü–µ–ª–∏
                                    </div>
                                    {% elif location.satisfaction >= 4 %}
                                    <span class="badge bg-secondary badge-category">
                                        <i class="fas fa-exclamation-circle"></i> –¢—Ä–µ–±—É–µ—Ç –≤–Ω–∏–º–∞–Ω–∏—è
                                    </span>
                                    <div class="mt-2 text-secondary small">
                                        <i class="fas fa-hand-paper"></i> –ù—É–∂–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è
                                    </div>
                                    {% else %}
                                    <span class="badge bg-danger badge-category">
                                        <i class="fas fa-exclamation-triangle"></i> –ö—Ä–∏—Ç–∏—á–Ω–æ
                                    </span>
                                    <div class="mt-2 text-danger small">
                                        <i class="fas fa-fire"></i> –°—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã!
                                    </div>
                                    {% endif %}
                                </td>
                                <td>
                                    {% set improvement = 10 - location.satisfaction %}
                                    <div class="text-center">
                                        <div class="fs-4 fw-bold text-{% if improvement <= 2 %}success{% elif improvement <= 3 %}warning{% else %}danger{% endif %}">
                                            +{{ improvement|round(1) }}
                                        </div>
                                        <div class="text-muted small">–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª —É–ª—É—á—à–µ–Ω–∏—è</div>
                                        <div class="mt-2">
                                            {% if improvement <= 2 %}
                                            <span class="badge bg-success">–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π</span>
                                            {% elif improvement <= 3 %}
                                            <span class="badge bg-warning">–£–º–µ—Ä–µ–Ω–Ω—ã–π</span>
                                            {% elif improvement <= 4 %}
                                            <span class="badge bg-danger">–í—ã—Å–æ–∫–∏–π</span>
                                            {% else %}
                                            <span class="badge bg-dark">–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="7" class="text-center text-muted py-5">
                                    <i class="fas fa-database fa-3x mb-3"></i>
                                    <h4>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ª–æ–∫–∞—Ü–∏—è—Ö</h4>
                                    <p>–ò–º–ø–æ—Ä—Ç–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –≤–∫–ª–∞–¥–∫—É "–ò–º–ø–æ—Ä—Ç"</p>
                                    <a href="/import" class="btn btn-primary mt-2">
                                        <i class="fas fa-file-import"></i> –ü–µ—Ä–µ–π—Ç–∏ –∫ –∏–º–ø–æ—Ä—Ç—É
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- –§—É—Ç–µ—Ä -->
            <div class="text-center mt-5 pt-4 border-top">
                <p class="text-muted">
                    <i class="fas fa-server"></i> –°–µ—Ä–≤–µ—Ä: 10.65.93.181:5004 |
                    <i class="fas fa-sync-alt"></i> –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç |
                    <i class="fas fa-map-marker-alt"></i> –õ–æ–∫–∞—Ü–∏–π: {{ locations|length }} |
                    <i class="fas fa-users"></i> –û—Ç–≤–µ—Ç–æ–≤: {{ total_responses }}
                </p>
                <div class="mt-3">
                    <button class="btn btn-primary me-2" onclick="window.print()">
                        <i class="fas fa-print"></i> –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
                    </button>
                    <button class="btn btn-success me-2" onclick="location.reload()">
                        <i class="fas fa-redo"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </button>
                    <a href="/import" class="btn btn-warning">
                        <i class="fas fa-file-import"></i> –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 15 –º–∏–Ω—É—Ç
        setTimeout(() => {
            location.reload();
        }, 900000);
        
        // –ü–æ–¥—Å–≤–µ—Ç–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏
        document.addEventListener('DOMContentLoaded', function() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-link').forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });
    </script>
</body>
</html>
